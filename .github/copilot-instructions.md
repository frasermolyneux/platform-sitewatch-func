# Copilot Instructions

- **Purpose**: .NET 9 isolated Azure Functions app that runs external HTTP availability checks on a 30s timer and reports `AvailabilityTelemetry` to Application Insights; infrastructure is managed via Terraform and deployed by GitHub Actions.
- **Entry point**: [src/MX.Platform.SiteWatch.App/Program.cs](../src/MX.Platform.SiteWatch.App/Program.cs) wires Functions defaults, registers Application Insights worker service, health checks, and binds `SiteWatchOptions`.
- **Timer flow**: [ExternalHealthCheck](../src/MX.Platform.SiteWatch.App/ExternalHealthCheck.cs) is a `TimerTrigger` (`0,30 * * * * *`) that iterates configured tests and issues HTTP GETs with a named `HttpClient` (`SiteWatch`, 10s timeout) wrapped in Polly `WaitAndRetryAsync` (3 attempts, 2/4/8s backoff) on non-success, `HttpRequestException`, or `TaskCanceledException`.
- **Telemetry fan-out**: Per test, `GetTelemetryClient` picks a connection string from `SiteWatchOptions.Telemetry` using the test's `app_insights` key, falling back to `default`; connections are built from app settings ending with `_appinsights_connection_string` or `ApplicationInsights:ConnectionString`/`APPINSIGHTS_CONNECTIONSTRING`. Each run emits `AvailabilityTelemetry` and flushes immediately.
- **Config sources**: `SiteWatchOptions.Tests` comes from configuration `SiteWatch:Tests`; if empty, the app reads JSON from `test_config` env/app setting (case-insensitive) into `List<TestConfig>`. Setting `SiteWatch:DisableExternalChecks` skips the timer entirely. Tokens shaped like `%TOKEN%` inside URLs are replaced from configuration keys of the same name; missing tokens throw.
- **Models**: [SiteWatchOptions](../src/MX.Platform.SiteWatch.App/SiteWatchOptions.cs) holds telemetry/test collections and the disable flag; [TestConfig](../src/MX.Platform.SiteWatch.App/TestConfig.cs) defines `app`, `app_insights`, and `uri` (required fields, JSON friendly); [TelemetryInitializer](../src/MX.Platform.SiteWatch.App/TelemetryInitializer.cs) stamps `Cloud.RoleName` as `Sitewatch FuncApp` for all telemetry.
- **Health endpoint**: [HealthCheck](../src/MX.Platform.SiteWatch.App/HealthCheck.cs) exposes anonymous `GET /api/health` returning the aggregated health status string from registered `HealthCheckService`.
- **Host settings**: [host.json](../src/MX.Platform.SiteWatch.App/host.json) sets `Function.HealthCheck` log level to Warning and enables sampling (exceptions excluded from sampling alongside availability).
- **Local loop**: From `src/MX.Platform.SiteWatch.App`, run `dotnet clean`, `dotnet build`, and `dotnet test --filter "FullyQualifiedName!~IntegrationTests"`. Local settings come from app settings or user secrets (UserSecretsId is set in the csproj).
- **Workflows**: `.github/workflows` uses reusable actions (`dotnet-func-ci`, `terraform-plan`, `terraform-plan-and-apply`, `deploy-function-app`) from `frasermolyneux/actions`. Key jobs: `build-and-test` on feature/bugfix/hotfix pushes; `pr-verify` validates PRs with dev plan by default, optional dev apply/deploy via `deploy-dev` label, and prd plan via `run-prd-plan`; `deploy-dev` manual; `deploy-prd` on main and weekly; `codequality` weekly/PR; `destroy-*` for manual teardown; `dependabot-automerge` and `copilot-setup-steps` maintenance.
- **Environment & auth**: Terraform/deploy steps use OIDC with `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, `AZURE_SUBSCRIPTION_ID` defined on GitHub environments. Keep `test_config` secrets and App Insights connections in app settings/Key Vault rather than committing them.
- **Terraform**: Infrastructure definitions live under `terraform/`; workflows plan/apply these configurations for Dev/Prd environments with concurrency guards.
- **Common pitfalls**: Ensure each test has a valid telemetry key or the default connection string; missing tokens in URLs throw; remember to flush telemetry is handled per run but App Insights requires connection strings to be present. Keep timer schedule aligned with expected frequency before changing the cron string.
